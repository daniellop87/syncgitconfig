#!/usr/bin/env bash
set -euo pipefail
CONF="/etc/syncgitconfig/syncgitconfig.yaml"
val(){ awk -F': ' -v k="$1" '$1==k {print $2}' "$CONF" | tr -d "\"'"; }

ENV="$(val env 2>/dev/null || true)"
HOST="$(val host 2>/dev/null || true)"
REPO="$(val repo_path 2>/dev/null || true)"
REMOTE="$(val remote_url 2>/dev/null || true)"
COOLDOWN="$(val cooldown 2>/dev/null || true)"

echo "== syncgitconfig status =="
[[ -f "$CONF" ]] && echo "Config: $CONF" || echo "Config: (no existe)"
echo "Repo:   ${REPO:-}"
echo "Remote: ${REMOTE:-}"
echo "Env:    ${ENV:-}"
echo "Host:   ${HOST:-}"
echo "Cooldown: ${COOLDOWN:-}"

STAGING="/var/lib/syncgitconfig/staging/${HOST:-unknown}"
echo "Staging: $STAGING"

APPS_CNT=$(ls -1 /opt/syncgitconfig/bin/app-sync-* 2>/dev/null | wc -l || true)
echo "Apps:   ${APPS_CNT}"

echo -e "\n-- Últimas 10 líneas del log --"
LOGFILE="/var/log/syncgitconfig/syncgitconfig.log"
[[ -f "$LOGFILE" ]] && tail -n 10 "$LOGFILE" || echo "(sin log)"

echo -e "\n-- Estado Git --"
if [[ -n "${REPO:-}" && -d "$REPO/.git" ]]; then
  git -C "$REPO" status -s || true
else
  echo "Repo no inicializado."
fi

echo -e "\nWatcher: $(systemctl is-active syncgitconfig-watch.service 2>/dev/null || echo unknown)"
