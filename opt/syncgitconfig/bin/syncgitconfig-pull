#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONF_PATH="${CONF_PATH:-/etc/syncgitconfig/syncgitconfig.yaml}"
# shellcheck source=/opt/syncgitconfig/lib/common.sh
. "$SCRIPT_DIR/../lib/common.sh"

main() {
  if ! load_config_yaml "$CONF_PATH"; then
    err "No se pudo cargar la configuración ($CONF_PATH)"
    exit 1
  fi

  ensure_https_token_credentials

  local repo="$CFG_repo_path"
  [[ -d "$repo/.git" ]] || { err "$repo no es un repo Git válido"; exit 1; }

  local branch
  branch="$(run_git -C "$repo" rev-parse --abbrev-ref HEAD 2>/dev/null || echo main)"
  ok "Pull de $repo (branch: $branch)"

  if run_git -C "$repo" pull --ff-only; then
    ok "Repositorio actualizado."
    exit 0
  fi

  warn "Divergencia detectada. Ejecutando stash + reset a origin/$branch"
  run_git -C "$repo" stash push -u -m "syncgitconfig-autostash-$(date -Iseconds)" || true
  run_git -C "$repo" fetch --prune || true
  run_git -C "$repo" reset --hard "origin/$branch"
  ok "Reset duro completado."
}

main "$@"
